---
title: "Informe de videos"
author: '@elartedemedir'
date: "22 de diciembre de 2015"
output:
  html_document:
    theme: cerulean
  pdf_document: default
---



El siguiente informe recoge el resultado de la obtención de datos a través de consultas a la api de Google Analytics para la obtención de los datos necesarios con los cuales realizar el cálculo de las métricas  y la obtención de los anteriores listados.

El script, que podrá se programado mediante un proceso de sistema en un servidor, generará para cada listado un fichero csv con los datos obtenidos para cada vídeos así como un fichero json en el que a cada video se le asigna un variable `rank` con el ranking de cada vídeo dentro del correspondiente top o listado.





```{r, echo=FALSE, results='hide',message=FALSE, warning=FALSE}
# rm(list = ls());gc()
# 
# invisible(library(RGA, warn.conflicts = FALSE, quietly=TRUE))
# #library(RGA)
# library("ggplot2")
# #require(scales)
# #library(forecast)
# library(lubridate)
# library(plyr)
# library(tidyr)
# library(tm)
# library(dplyr)
# library(splitstackshape)
# library(jsonlite)
# library(knitr)
# 
# 
# Sys.setenv(RGA_CLIENT_ID = "1099046822903-fihc0lcqnv1gj4fe5k7sllbv9ejj0nqo.apps.googleusercontent.com", RGA_CLIENT_SECRET = "ZHs5oDJ1lZERgvhj-fW3_CKj")

end.date <- as.Date(Sys.Date() - 1) # fin: ayer
start.date <- as.Date(Sys.Date() - 1) # inicio

ga.profileId <- '110633069'

```

Para la generación de estos datos se ha consultado el site pichaloca.com y se han extraido datos para el periodo `r start.date` y `r end.date` 

```{r, echo=FALSE, results='hide',message=FALSE, warning=FALSE}

# ga_token <- authorize(client.id = '1099046822903-fihc0lcqnv1gj4fe5k7sllbv9ejj0nqo.apps.googleusercontent.com', client.secret = 'ZHs5oDJ1lZERgvhj-fW3_CKj', cache = ".gatoken")
ga_token <- authorize(cache = ".gatoken")

video.categories.metrics.df <- try(
  get_ga(profile.id = ga.profileId, 
         start.date = start.date, 
         end.date = end.date, 
         metrics = "ga:productDetailViews,ga:productAddsToCart,ga:cartToDetailRate", 
         dimensions = "ga:dimension4,ga:productSku,ga:productName,ga:productCategoryHierarchy", 
         sort = "-ga:productAddsToCart", 
         filters = "ga:productCategoryHierarchy!@(not set);ga:productAddsToCart>100", 
         max.results = NULL,
         sampling.level = "FASTER", token = ga_token), 
  silent = FALSE)
#summary(video.categories.metrics.df)
#video.categories.metrics.df %>%  group_by(dimension4) %>%  dplyr::summarise(n = mean(product.adds.to.cart),s = sum(product.adds.to.cart))
#video.categories.metrics.df %>% filter(dimension4 == "Pichaloca_en") %>%  dplyr::summarise(n = mean(product.adds.to.cart),s = sum(product.adds.to.cart))
names(video.categories.metrics.df) <- c(
  "site",
  "product.sku", 
  "product.name", 
  "product.category", 
  "detail", 
  "play",
  "playtodetailrate")
# head(video.categories.metrics.df)

video.pornstar.metrics.df <- try(
  get_ga(profile.id = ga.profileId, 
         start.date = start.date, 
         end.date = end.date, 
         metrics = "ga:productListViews,ga:productDetailViews,ga:productAddsToCart,ga:cartToDetailRate", 
         dimensions = "ga:dimension4,ga:productSku,ga:dimension17,ga:dimension15,ga:productName", 
         sort = "-ga:productAddsToCart", 
         filters = "ga:dimension17!=(not set);ga:productAddsToCart>100", 
         sampling.level = "FASTER", token = ga_token), 
  silent = TRUE)

names(video.pornstar.metrics.df) <- c(
  "site",
  "product.sku", 
  "porn.star", 
  "lenght", 
  "product.name", 
  "impressions",
  "detail","play",
  "playtodetailrate"
  )
# head(video.pornstar.metrics.df)



#filtrae por productAddsToCart >= 0
video.interaction.metrics.df <- try(
    get_ga(
        profile.id = ga.profileId, 
        start.date = start.date, 
        end.date = end.date, 
        metrics = "ga:productListViews,ga:productDetailViews,ga:productAddsToCart,ga:cartToDetailRate", 
        dimensions = "ga:dimension4,ga:productSku,ga:dimension13,ga:dimension15,ga:dimension16,ga:productName", 
        sort = "-ga:productAddsToCart", 
        filters = "ga:dimension13!=(not set);ga:productAddsToCart>100", 
        sampling.level = "FASTER", token = ga_token), 
      silent = TRUE)
         
names(video.interaction.metrics.df) <- c(
           "site",
           "product.sku", 
           "tags", 
           "lenght", 
           "rating", 
           "product.name", 
           "impressions",
           "detail","play",
           "playtodetailrate"
           )

video.interaction.metrics.df <- video.interaction.metrics.df %>% mutate(video.id = sapply(strsplit(as.character(product.sku), "_"), tail, 1))
# head(video.interaction.metrics.df)
 




video.social.metrics.df <- try(
  get_ga(profile.id = ga.profileId, 
         start.date = start.date, 
         end.date = end.date, 
         metrics = "ga:uniqueSocialInteractions", 
         dimensions = "ga:dimension4,ga:socialInteractionNetwork,ga:socialInteractionTarget", 
         sort = "-ga:uniqueSocialInteractions", 
         filters = "ga:socialInteractionNetwork!=undefined;ga:pagePath=~(/video/|/films/|/видео/|/filmy/|/videolari/|/porn-video/|/filme/|/videos/);ga:socialInteractionTarget!~^http;ga:uniqueSocialInteractions>0",
         sampling.level = "FASTER", token = ga_token), 
  silent = TRUE)

# head(video.social.metrics.df)

names(video.social.metrics.df) <- c(
  "site",
  "social.interaction.network",
  "product.sku", 
  "social.interactions")

video.social.metrics.df <- video.social.metrics.df %>% 
  mutate(video.id = sapply(strsplit(as.character(product.sku), "_"), tail, 1))

# head(video.social.metrics.df)

video.engagement.metrics.df <- try(
  get_ga(profile.id = ga.profileId, 
         start.date = start.date, 
         end.date = end.date, 
         metrics = "ga:uniqueEvents,ga:eventValue", 
         dimensions = "ga:eventLabel", 
         sort = "-ga:eventValue", 
         filters = "ga:eventAction=@Time on screen;ga:uniqueEvents>0",
         sampling.level = "FASTER", token = ga_token),  
  silent = TRUE)

# head(video.engagement.metrics.df)

#el objetivo es tener los engagement time de cada video para cruzarlos con los tags
video.engagement.metrics.df <- video.engagement.metrics.df %>% 
  filter(grepl("^[a-zA-Z]{1,}_[a-z]{2}_[0-9]{4,5}$", event.label)) %>% 
  mutate(engament.time = event.value / unique.events) %>% 
  select(event.label, engament.time) %>% 
  arrange(desc(engament.time)) %>% 
  mutate(video.id = sapply(strsplit(as.character(event.label), "_"), tail, 1))

names(video.engagement.metrics.df) <- c("product.sku", "engament.time", "video.id")

# head(video.engagement.metrics.df)

video.df <- join_all(
  list(video.interaction.metrics.df,video.engagement.metrics.df),
  by=c('video.id','product.sku'),
  type='left',
  match = "first")

# video.df <- left_join(video.interaction.metrics.df,video.engagement.metrics.df,
#   by='product.sku',
#   type='left',
#   match = "all")
# 
# 
# video.df <- join_all(
#   list(video.interaction.metrics.df,video.engagement.metrics.df),
#   by='product.sku',
#   type='left',
#   match = "all")

#elimnamos los vídeos que no han generado engagement time
video.df <- video.df %>%  filter(!is.na((engament.time)))

# head(video.df)


#videos con mayor play
video.df <- video.df %>%
  filter(play > quantile(play, 0.9)) %>% 
  mutate( eng.ratio = engament.time / lenght * 100) %>% 
  filter(eng.ratio < 100) %>% 
  arrange(-(eng.ratio)) 
# %>% 
#   mutate(video.id = sapply(strsplit(as.character(product.sku), "_"), tail, 1))


# head(video.df)



video.pornstar.df <- join_all(
  list(video.pornstar.metrics.df,video.engagement.metrics.df),
  by='product.sku',
  type='left',
  match = "all")
# head(video.pornstar.df)

video.pornstar.df <- video.pornstar.df %>%
  filter(play > quantile(play, 0.9)) %>% 
  mutate( eng.ratio = engament.time / lenght * 100) %>% 
  filter(eng.ratio < 100) %>% 
  arrange(-(eng.ratio)) 
#   %>% 
#   mutate(video.id = sapply(strsplit(as.character(product.sku), "_"), tail, 1))







#LOS MAS VISTOS: TOP PLAYS
#detach(package:plyr)
# head(video.interaction.metrics.df)


top_plays.df  <- filter(video.interaction.metrics.df, grepl("^[a-zA-Z]{1,}_[a-z]{2}_[0-9]{4,5}$", product.sku)) %>%  group_by(site, video.id) %>% dplyr::summarise(avg.play = mean(play)) %>% top_n(20, wt = avg.play)
# head(top_plays.df)

top_plays.plot <- head(top_plays.df, 60)


tmp_reorder_v1 <- with(top_plays.plot,reorder(top_plays.plot$video.id, top_plays.plot$avg.play))
v1 <- ggplot(top_plays.plot , aes(x=tmp_reorder_v1, y=avg.play, fill=factor(site))) + geom_bar(stat = "identity") + coord_flip()  + theme_bw(base_size = 12, base_family = "Helvetica") + theme()


# top_plays.df  <- filter(video.interaction.metrics.df, grepl("^[a-zA-Z]{1,}_[a-z]{2}_[0-9]{4,5}$", product.sku)) %>%  group_by(video.id, product.name) %>% dplyr::summarise(avg.play = mean(play, na.rm=T))  %>% ungroup() %>% arrange(desc(avg.play)) %>% top_n(20, wt = avg.play)
# head(top_plays.df)
# 
# 
# tmp_reorder_v1 <- with(top_plays.df,reorder(top_plays.df$product.name, top_plays.df$avg.play))
# v1 <- ggplot(top_plays.df, aes(x=tmp_reorder_v1, y=avg.play, fill=factor(product.name))) + geom_bar(stat = "identity") + coord_flip()  + theme_bw(base_size = 12, base_family = "Helvetica") + theme(legend.position="none")


#OUTPUT CSV
write.csv(top_plays.df, file="top_played_videos.csv", row.names=FALSE)   

#OUTPUT JSON

ranked.df <- transform(top_plays.df, 
          rank = ave(avg.play, 
                          FUN = function(x) rank(-x, ties.method = "first"))) %>% 
  select(site,video.id, rank)
ranked.json <- toJSON(ranked.df)
write(ranked.json, file="top_played_videos.json") 
rm(list = c("ranked.df","ranked.json"))
```

# Top videos (Por reproducciones)

Para obtener el top de videos por reproducciones se ha obtenido el número medio de reproducciones (`avg.play`) para cada video en un periodo determinado.

[Download CSV](top_played_videos.csv) | [Download Json](top_played_videos.json)

El archivo Json contiene los identificadores de cada video así como el orden asignado.


```{r, results='asis', echo=FALSE}
knitr::kable(top_plays.df, format = "markdown", padding = 0, caption = "Title of the table")
```

```{r fig.width=7, fig.height=4, echo=FALSE}
print(v1)
```


# Top videos (Engagement)

```{r, echo=FALSE, results='hide',message=FALSE, message=F, warning=F}
top_engament.df <- video.df %>% filter(grepl("^[a-zA-Z]{1,}_[a-z]{2}_[0-9]{4,5}$", product.sku)) %>% select(site,product.sku, product.name, play, eng.ratio) %>%  group_by(site,product.sku, product.name) %>%  dplyr::summarise(avg.eng.ratio = mean(eng.ratio, na.rm=T)) %>% ungroup() %>%  dplyr::arrange(desc(avg.eng.ratio)) 
# head(top_engament.df)




top_engament.df <- video.df %>% filter(grepl("^[a-zA-Z]{1,}_[a-z]{2}_[0-9]{4,5}$", product.sku)) %>% select(site,video.id, product.name, eng.ratio)   %>%  dplyr::arrange(desc(eng.ratio))
# head(top_engament.df)

###OK
top_engament.df <- top_engament.df[ave(top_engament.df$eng.ratio, top_engament.df$video.id, FUN = rank) <= 10, ] %>% group_by(site)  

top_engament.plot <- top_engament.df %>% top_n(3, wt=eng.ratio)

#para exportar
top_engament.df <- top_engament.df %>% top_n(20, wt=eng.ratio)



tmp_reorder_v2 <- with(top_engament.plot,reorder(top_engament.plot$product.name, top_engament.plot$eng.ratio))
v2 <- ggplot(top_engament.plot, aes(x=tmp_reorder_v2, y=eng.ratio, fill=factor(site))) + geom_bar(stat = "identity") + coord_flip()  + theme_bw(base_size = 12, base_family = "Helvetica") + theme()

#OUTPUT CSV
write.csv(top_engament.df, file="top_engaged_videos.csv", row.names=FALSE)   

#OUTPUT JSON

ranked.df <- transform(top_engament.df, 
          rank = ave(eng.ratio, 
                          FUN = function(x) rank(-x, ties.method = "first"))) %>% 
  select(site, video.id, rank)
ranked.json <- toJSON(ranked.df)
write(ranked.json, file="top_engaged_videos.json") 
rm(list = c("ranked.df","ranked.json"))

```

La obtención del top vídeos por tasa de engagement se ha calculado inicialmente para todos los videos el tiempo que permanece un usuario viendo el vídeo. A continuación se ha procedido a calcular la tasa de engagement de cada video teniendo en cuenta la duración de cada video.

A continuación y con el objeto de no tener en cuenta aquellos videos con una alta tasa de engagement y con un bajo número de reproducciones, se han mantenido únicamente los vídeos que se encuentrar en el 10% de vídeos más vistos de entro todos los visualizados en el periodo.

Finalmente se a procedido a ordenar los videos en orden descendente por dicha tasa de engagement. De esta forma obtenemos videos los videos que suman una alta tasa de engagement y de reproducciones.

[Download CSV](top_engaged_videos.csv) | [Download Json](top_engaged_videos.json)


```{r, results='asis', echo=FALSE}
knitr::kable(top_engament.plot, format = "markdown", padding = 0, caption = "Title of the table")
```

```{r fig.width=7, fig.height=4, echo=FALSE}
print(v2)
```


# Top pornstars (By plays)

```{r, echo=FALSE}
library(splitstackshape)
top_pornstar_plays.df <- video.pornstar.metrics.df %>% filter(grepl("^[a-zA-Z]{1,}_[a-z]{2}_[0-9]{4,5}$", product.sku)) %>% select(site, product.sku, product.name,porn.star, play) %>% cSplit("porn.star", sep = "|", direction = "long") %>%  group_by(site, porn.star) %>%  dplyr::summarise(plays = mean(play, na.rm=T)) %>% ungroup() %>%  dplyr::arrange(desc(plays)) 
#%>% top_n(20, wt = plays)


top_pornstar_plays.df <- top_pornstar_plays.df[ave(top_pornstar_plays.df$plays, top_pornstar_plays.df$porn.star, FUN = rank) <= 10, ] %>% group_by(site)  

top_pornstar_plays.plot <- top_pornstar_plays.df %>% top_n(3, wt=plays)
top_pornstar_plays.df <- top_pornstar_plays.df %>% top_n(20, wt=plays)

tmp_reorder_p1 <- with(top_pornstar_plays.plot,reorder(top_pornstar_plays.plot$porn.star, top_pornstar_plays.plot$plays))

p1 <- ggplot(top_pornstar_plays.plot, aes(x=tmp_reorder_p1, y=plays, fill=factor(site))) + geom_bar(stat = "identity") + coord_flip()  + theme_bw(base_size = 12, base_family = "Helvetica") + theme() + 
  xlab("Porn Start") +
  ylab("Total Video Plays") +
  ggtitle(bquote(atop("Top Porn Stars by Video Plays", atop(italic(.("Grouped by site", "")))))) 


top_pornstar_engament.df <- video.pornstar.df %>% filter(grepl("^[a-zA-Z]{1,}_[a-z]{2}_[0-9]{4,5}$", product.sku)) %>% select(site, product.sku, product.name,porn.star, play, eng.ratio) %>% cSplit("porn.star", sep = "|", direction = "long") %>%  group_by(site, porn.star) %>%  dplyr::summarise(avg.eng.ratio = mean(eng.ratio, na.rm=T)) %>% ungroup() %>%  dplyr::arrange(desc(avg.eng.ratio)) 

top_pornstar_engament.df <- top_pornstar_engament.df[ave(top_pornstar_engament.df$avg.eng.ratio, top_pornstar_engament.df$porn.star, FUN = rank) <= 10, ] %>% group_by(site)  

top_pornstar_engament.plot <- top_pornstar_engament.df %>% top_n(3, wt=avg.eng.ratio)
top_pornstar_engament.df <- top_pornstar_engament.df %>% top_n(20, wt=avg.eng.ratio)

tmp_reorder_p2 <- with(top_pornstar_engament.plot,reorder(top_pornstar_engament.plot$porn.star, top_pornstar_engament.plot$avg.eng.ratio))

p2 <- ggplot(top_pornstar_engament.plot, aes(x=tmp_reorder_p2, y=avg.eng.ratio, fill=factor(site))) + geom_bar(stat = "identity") + coord_flip()  + theme_bw(base_size = 12, base_family = "Helvetica") + theme() + 
  xlab("Porn Start") +
  ylab("Average Engagement Ratio") +
  ggtitle(bquote(atop("Top Porn Stars by Average Engagement Ratio", atop(italic(.("Grouped by site", "")))))) 

#OUTPUT CSV PLAYS
write.csv(top_pornstar_plays.df, file="top_pornstar_plays.csv", row.names=FALSE)   

#OUTPUT JSON PLAYS

ranked.df <- transform(top_pornstar_plays.df, 
          rank = ave(plays, 
                          FUN = function(x) rank(-x, ties.method = "first"))) %>% 
  select(site, porn.star, rank) %>% dplyr::arrange(desc(site), rank)
ranked.json <- toJSON(ranked.df)
write(ranked.json, file="top_pornstar_plays.json") 
rm(list = c("ranked.df","ranked.json"))

#OUTPUT CSV ENG
top_pornstar_engament.df <- top_pornstar_engament.df %>% dplyr::arrange(desc(site), desc(avg.eng.ratio))
write.csv(top_pornstar_engament.df, file="top_pornstar_engament.csv", row.names=FALSE)   

#OUTPUT JSON ENG

ranked.df <- transform(top_pornstar_engament.df, 
          rank = ave(avg.eng.ratio, 
                          FUN = function(x) rank(-x, ties.method = "first"))) %>% 
  select(site, porn.star, rank) %>% dplyr::arrange(desc(site), rank)
ranked.json <- toJSON(ranked.df)
write(ranked.json, file="top_pornstar_engament.json") 
rm(list = c("ranked.df","ranked.json"))

```

Se ha obtenido el top de pornstars tanto por videos reproducidos como por tasa de engagement. Dado que los vídeos están asignados a varias pornstars se ha asginado el número de reproducciones así como la tasa de engagement a cada pornstar a partes iguales obteniendo un ranking global de para cada uno de los actores/actrices para finalmente obtener el valor medio para el periodo.

Mediante el resultado obtenido se podrían ordenar tanto los actores en las secciones de pornstars, como sacar listas top de actores en diferentes secciones del site, ordenar vídeos en resultados de búsqueda por actor, etc.

[Download Top Pornstars Plays CSV](top_pornstar_plays.csv) | [Download Download Top Pornstars Plays Json](top_pornstar_plays.json)

[Download Top Pornstars Engament CSV](top_pornstar_engament.csv) | [Download Top Pornstars Engament Json](top_pornstar_engament.json)

# Top pornstars por reproducciones de vídeos

```{r, results='asis', echo=FALSE}
knitr::kable(top_pornstar_plays.plot, format = "markdown", padding = 0, caption = "Title of the table")
```

```{r fig.width=7, fig.height=4, echo=FALSE}
print(p1)
```

# Top pornstars por tasa de engament

```{r, results='asis', echo=FALSE}
knitr::kable(top_pornstar_engament.plot, format = "markdown", padding = 0, caption = "Title of the table")
```

```{r fig.width=7, fig.height=4, echo=FALSE}
print(p2)
```

# Top videos por categoría (Por reproducciones)

```{r, echo=FALSE}
#TOP 10 VIDEOS POR CATEGORIA



top_n_by_category.df <- video.categories.metrics.df %>% filter(grepl("^[a-zA-Z]{1,}_[a-z]{2}_[0-9]{4,5}$", product.sku)) %>% select(site, product.sku, product.name,product.category, play) %>% cSplit("product.category", sep = "|", direction = "long")  %>% group_by(site, product.category, product.sku) %>%  dplyr::summarise(avg.play = mean(play, na.rm=T)) %>% ungroup() %>% dplyr::arrange(desc(avg.play), site,product.category ) 


#top_n_by_category.df <- top_n_by_category.df[ave(top_n_by_category.df$avg.play, top_n_by_category.df$product.category, FUN = rank) <= 10, ] %>% group_by(site, product.category)  

top_n_by_category.df <- transform(top_n_by_category.df %>% group_by(site, product.category, product.sku), 
          rank = ave(avg.play, 
                          FUN = function(x) rank(-x, ties.method = "first"))) %>% group_by(site, product.category)%>% arrange(site, product.category, rank) %>% 
  mutate(video.id = sapply(strsplit(as.character(product.sku), "_"), tail, 1))

top_n_by_category.plot <- top_n_by_category.df  %>% top_n(3, wt=-rank) 

top_n_by_category.df <- top_n_by_category.df %>% top_n(20, wt=-rank)

#%>% top_n(5, wt = avg.play) %>% 

#top_n_by_category.df %>% group_by(site, product.category) %>% summarise(length(unique(product.category)))

Data <- ddply(top_n_by_category.plot, .(product.category), 
              transform, pos = cumsum(avg.play) - (0.5 * avg.play)) %>% top_n(75, wt = -rank)
              
c0 <- ggplot(Data, aes(x=product.category, y=avg.play, fill=factor(video.id))) + geom_bar(stat = "identity") + coord_flip()  + theme_bw(base_size = 12, base_family = "Helvetica") + geom_text(aes(label = video.id ,y= pos), size = 3) + theme(legend.position="none")   + 
  xlab("Video Category") +
  ylab("Total Video Plays") +
  ggtitle(bquote(atop("Top 3 Videos by Video Plays", atop(italic(.("Grouped by Video Category", ""))))))            

rm(Data)

#c1 <- ggplot(Data, aes(x=product.category, y=avg.play, fill=factor(product.sku))) + geom_bar(stat = "identity") + coord_flip()  + theme_bw(base_size = 12, base_family = "Helvetica") + geom_text(aes(label = product.sku), size = 3) + theme(legend.position="none")   


#c2 <- ggplot(Data, aes(x=factor(product.sku), y=avg.play, fill = factor(product.category))) + geom_bar(stat = "identity")  +  theme_bw(base_size = 12, base_family = "Helvetica")  + theme(legend.position="none", axis.text=element_text(size=8)) + facet_wrap(~ product.category, scales="free_x", ncol=3)              
     


#OUTPUT CSV
write.csv(top_n_by_category.df, file="top_videos_by_category.csv", row.names=FALSE)   

#OUTPUT JSON

#top_n_by_category.df %>% group_by(product.category) %>% select(product.sku,  avg.play) %>%  dplyr::summarise(rank= rank(avg.play, ties.method = "first")) %>% ungroup() %>% select(product.sku, product.category,  rank)


ranked.df <- transform(top_n_by_category.df %>% group_by(product.category), 
          rank = ave(avg.play, 
                          FUN = function(x) rank(-x, ties.method = "first"))) %>% 
  select(site, product.sku, product.category,  rank)
ranked.json <- toJSON(ranked.df)
write(ranked.json, file="top_videos_by_category.json") 
rm(list = c("ranked.df","ranked.json"))

```

La siguiente tabla recoge, a modo de resumen, el top 3 de videos reproducidos dentro de su correspondiente categoría.

[Download CSV](top_videos_by_category.csv) | [Download Json](top_videos_by_category.json)



```{r, results='asis', echo=FALSE}
# knitr::kable(top_n_by_category.df %>% top_n(3, wt = avg.play), format = "markdown", padding = 0, caption = "Title of the table")
```



```{r fig.width=10, fig.height=8, echo=FALSE}
print(c0)
```

# Top vídeos más votados

```{r, echo=FALSE}


top_rating.df  <- video.interaction.metrics.df %>% filter(grepl("^[a-zA-Z]{1,}_[a-z]{2}_[0-9]{4,5}$", product.sku)) %>%  group_by(site, product.sku, product.name) %>% dplyr::summarise(avg.rating = mean(rating, na.rm=T))  %>% ungroup() %>% arrange(desc(avg.rating)) %>% top_n(20, wt = avg.rating) %>% 
  mutate(video.id = sapply(strsplit(as.character(product.sku), "_"), tail, 1))

# head(top_rating.df)

#HACER!!!!
#top_n_by_category.plot <- top_n_by_category.df  %>% top_n(3, wt=-rank) 

#top_n_by_category.df <- top_n_by_category.df %>% top_n(20, wt=-rank)


tmp_reorder_r1 <- with(top_rating.df,reorder(top_rating.df$product.name, top_rating.df$avg.rating))
v1 <- ggplot(top_rating.df, aes(x=tmp_reorder_r1, y=avg.rating, fill=factor(site))) + geom_bar(stat = "identity") + coord_flip()  + theme_bw(base_size = 12, base_family = "Helvetica") + theme() + 
  xlab("Video") +
  ylab("Video Rating") +
  ggtitle(bquote(atop("Top Videos by User Ratings", atop(italic(.("Grouped by Site", ""))))))         

#OUTPUT CSV
write.csv(top_rating.df, file="top_rating.csv", row.names=FALSE)   

#OUTPUT JSON

ranked.df <- transform(top_rating.df, 
          rank = ave(avg.rating, 
                          FUN = function(x) rank(-x, ties.method = "first"))) %>% 
  select(site, video.id, rank)
ranked.json <- toJSON(ranked.df)
write(ranked.json, file="top_rating.json") 
rm(list = c("ranked.df","ranked.json"))

```


Este listado muestra los votos para cada video en el momento seleccionado.

[Download CSV](top_rating.csv) | [Download Json](top_rating.json)

```{r, results='asis', echo=FALSE}
knitr::kable(top_rating.df, format = "markdown", padding = 0, caption = "Title of the table")
```

```{r fig.width=7, fig.height=4, echo=FALSE}
print(v1)
```

# Top vídeos más compartidos

Top videos con más interacciones sociales (Facebook y Twitter)


```{r, echo=FALSE}

# head(video.social.metrics.df)

## elinamos la columana duplicada head(video.categories.metrics.df[ , -which(names(video.categories.metrics.df) %in% c("site"))])

##OJO hay qye enviar el site al csv y al json


top_shares.df <- join_all(list(video.social.metrics.df, video.categories.metrics.df[ , -which(names(video.categories.metrics.df) %in% c("site"))]), by = "product.sku", type = "left", match = "first") %>%  select(site, product.sku, product.name, social.interactions, social.interaction.network) %>% group_by(site, product.sku, product.name) %>% dplyr::summarise(shares = sum(social.interactions, na.rm=T))  %>% arrange(desc(shares)) %>% dplyr::top_n(50, wt = shares) %>% 
  mutate(video.id = sapply(strsplit(as.character(product.sku), "_"), tail, 1))
top_shares.df <- head(top_shares.df, 100) 


tmp_reorder_s1 <- with(top_shares.df,reorder(top_shares.df$product.name, top_shares.df$shares))
s1 <- ggplot(top_shares.df, aes(x=tmp_reorder_s1, y=shares, fill=factor(site))) + geom_bar(stat = "identity") + coord_flip()  + theme_bw(base_size = 12, base_family = "Helvetica") + theme()  + 
  xlab("Video") +
  ylab("Video Shares") +
  ggtitle(bquote(atop("Top Videos by Social Sharing", atop(italic(.("Grouped by Site", ""))))))     

#OUTPUT CSV
write.csv(top_shares.df, file="top_shares.csv", row.names=FALSE)   

#OUTPUT JSON

ranked.df <- transform(top_shares.df, 
          rank = ave(shares, 
                          FUN = function(x) rank(-x, ties.method = "first"))) %>% 
  select(site, video.id, rank)
ranked.json <- toJSON(ranked.df)
write(ranked.json, file="top_shares.json") 
rm(list = c("ranked.df","ranked.json"))

```

[Download CSV](top_shares.csv) | [Download Json](top_shares.json)

```{r, results='asis', echo=FALSE}
knitr::kable(top_shares.df, format = "markdown", padding = 0, caption = "Title of the table")
```

```{r fig.width=7, fig.height=4, echo=FALSE}
print(s1)
```